# NeuNetwork — Solution Design — V2

## 1. Overview
V2 adds a **model comparison utility** that computes McNemar’s matched‑pairs test from two `infer.json` files generated by separate `neunet infer` runs on the same images.

## 2. Architecture Impact
No changes to core training/eval/infer modules. Comparison is added as a **standalone utility** under `utilities/mcnemar_test.py` to keep the CLI stable. It can be later promoted to `neunet compare`.

```
infer.json (A)        infer.json (B)
     │                      │
     └───► load/parse  ◄────┘
             │  (map filename → {truth, pred})
             ▼
        build 2×2 contingency
             ▼
   exact binomial p + chi² CC
             ▼
      console + optional CSV
```

## 3. Module Design

### 3.1 File: `utilities/mcnemar_test.py`
- **Key funcs**
  - `extract_items()` — schema‑tolerant loader (`list` or `{results|items|predictions: [...]}`); fields: `file`, `pred`.
  - `parse_truth_from_filename()` — regex `_label(?P<label>\d+)\.`; raises on mismatch.
  - `build_contingency()` — computes a,b,c,d and per‑file correctness.
  - `mcnemar_exact(b,c)` — two‑sided binomial p‑value on discordants.
  - `mcnemar_chi2_cc(b,c)` — Edwards’ continuity‑corrected chi‑square.
  - `run_mcnemar()` — public API to get table/p‑values as a dict.
- **CLI**
  - `python utilities/mcnemar_test.py inferA.json inferB.json [--dump CSV] [--alpha 0.05]`
  - Prints the table and p‑values; optional CSV with per‑file (dis)agreements.

### 3.2 Data contracts
- **Input record (minimum):**
  ```json
  {"file": "some/001_label3.png", "pred": 3}
  ```
- **Assumption:** truth label is embedded in filename `_label<digit>` (0–9).

### 3.3 Errors & Edge Cases
- Empty intersection of filenames → `ValueError` with guidance.
- Missing required fields (`file`, `pred`) → `ValueError`.
- Zero discordants (`b+c == 0`) → p=1.0; chi² stat=0.0, p=1.0.

### 3.4 Complexity
- Time: O(N); Memory: O(N) for per‑file map.

### 3.5 Testing
- **Unit:** regex parser, list/dict payloads, contingency math, p‑values.
- **Integration:** two real `infer.json` files (n≈20) produce stable outputs.
- **Golden CSV:** optional snapshot for `--dump` format.

## 4. Deployment & Ops
- Script lives in `utilities/`; no extra dependency beyond stdlib.
- Optional future: add `statsmodels` as extra to use their `mcnemar` for cross‑check.
- Documented in README with example commands.

## 5. Security & Privacy
- Processes offline JSONs only; no PII.

## 6. Future Work
- Integrate as `neunet compare` subcommand.
- Confidence intervals for discordant proportions; bootstrap CI for accuracy deltas.
- Extend to McNemar‑Browns for multi‑class marginal homogeneity (if needed).